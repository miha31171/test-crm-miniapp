<!DOCTYPE html>
<html><head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width">
<title>üé® CRM –¢–∞—Ç—É</title>
<style>
* {margin:0;padding:0;box-sizing:border-box}
body{font-family:system-ui;background:var(--tg-theme-bg-color);color:var(--tg-theme-text-color);padding:16px;line-height:1.4}
h1,h2{font-size:20px;margin:20px 0 12px}
h3{font-size:16px;margin:16px 0 8px}
input,select{width:100%;padding:12px;margin:6px 0;border-radius:8px;border:1px solid var(--tg-theme-hint-color);background:var(--tg-theme-secondary-bg-color);color:var(--tg-theme-text-color);font-size:16px}
button{width:100%;padding:14px;background:var(--tg-theme-button-color);color:var(--tg-theme-button-text-color);border:none;border-radius:8px;font-size:16px;font-weight:600;margin:8px 0 12px;cursor:pointer}
.booking,.slot{background:var(--tg-theme-secondary-bg-color);padding:16px;border-radius:12px;margin:12px 0;border-left:4px solid var(--tg-theme-button-color)}
.admin-section{background:var(--tg-theme-secondary-bg-color);padding:20px;border-radius:16px;margin:20px 0}
#slots-list,#bookings-list{max-height:240px;overflow-y:auto}
.small{font-size:14px;opacity:0.8}
</style>
</head>
<body>
<h1> CRM –¢–∞—Ç—É –°–∞–ª–æ–Ω</h1>

<!-- –ö–ª–∏–µ–Ω—Ç—Å–∫–∞—è —Ñ–æ—Ä–º–∞ -->
<div>
<h2>üìÖ –ó–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ —Ç–∞—Ç—É</h2>
<select id="slot-select" style="font-size:16px;height:50px">
  <option value="">üëÜ –í—ã–±–µ—Ä–∏—Ç–µ —Å–≤–æ–±–æ–¥–Ω—ã–π —Å–ª–æ—Ç</option>
  {% for s in slots %}
  <option value="{{ s.id }}" data-master="{{ s.master }}" data-date="{{ s.date }}" data-time="{{ s.time }}">
    {{ s.master }} ‚Ä¢ {{ s.date }} {{ s.time }}
  </option>
  {% endfor %}
</select>
<input id="client-name" placeholder="–ò–º—è">
<input id="client-phone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω">
<input id="client-place" placeholder="–ú–µ—Å—Ç–æ —Ç–∞—Ç—É (—Ä—É–∫–∞, –Ω–æ–≥–∞, —Å–ø–∏–Ω–∞...)">
<button onclick="bookSlot()">‚úÖ –ó–∞–ø–∏—Å–∞—Ç—å—Å—è</button>
</div>

{% if is_admin %}
<!-- –ê–¥–º–∏–Ω–∫–∞ -->
<div class="admin-section">
<h2>‚öôÔ∏è –ê–¥–º–∏–Ω–∫–∞ –º–∞—Å—Ç–µ—Ä–∞</h2>

<h3>‚ûï –î–æ–±–∞–≤–∏—Ç—å –º–∞—Å—Ç–µ—Ä–∞</h3>
<input id="master-name" placeholder="–ò–º—è –º–∞—Å—Ç–µ—Ä–∞ (–ê–Ω–Ω–∞, –ò–≤–∞–Ω...)">
<input id="master-tg" placeholder="Telegram ID (9 —Ü–∏—Ñ—Ä)" type="number">
<button onclick="addMaster()">–î–æ–±–∞–≤–∏—Ç—å –º–∞—Å—Ç–µ—Ä–∞</button>

<h3>üóìÔ∏è –î–æ–±–∞–≤–∏—Ç—å —Å–ª–æ—Ç</h3>
<select id="master-select">
  {% for m in masters %}
  <option value="{{ m.id }}">{{ m.name }}</option>
  {% endfor %}
</select>
<input id="slot-date" type="date" min="2026-01-10">
<input id="slot-time" type="time" min="09:00" max="21:00">
<button onclick="addSlot()">‚ûï –°–æ–∑–¥–∞—Ç—å —Å–ª–æ—Ç</button>
</div>
{% endif %}

<!-- –ó–∞–ø–∏—Å–∏ -->
<h2>üìã –í—Å–µ –∑–∞–ø–∏—Å–∏</h2>
<div id="bookings-list">
  {% for b in bookings %}
  <div class="booking">
    <strong>{{ b.name }}</strong> {{ b.phone }}<br>
    {{ b.place }} ‚Ä¢ {{ b.master }} {{ b.date }} {{ b.time }}<br>
    <small>{{ b.id }}</small>
  </div>
  {% endfor %}
  {% if not bookings %}
  <div class="slot">üì≠ –ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π</div>
  {% endif %}
</div>

<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script>
const tg = window.Telegram.WebApp;
tg.expand();
tg.MainButton.setText("üîÑ –û–±–Ω–æ–≤–∏—Ç—å").show().onClick(()=>location.reload());

async function bookSlot(){
  const slotId = document.getElementById('slot-select').value;
  const name = document.getElementById('client-name').value;
  const phone = document.getElementById('client-phone').value;
  const place = document.getElementById('client-place').value;
  
  if(!slotId||!name||!phone||!place){
    tg.showAlert("‚ùå –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!");
    return;
  }
  
  try{
    const res = await fetch('/api/book', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({slot_id:slotId,name,phone,place})
    });
    const data = await res.json();
    tg.showAlert(data.ok?data.message:data.error);
    if(data.ok) location.reload();
  }catch(e){
    tg.showAlert("‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏");
  }
}

async function addSlot(){
  const masterId = document.getElementById('master-select').value;
  const date = document.getElementById('slot-date').value;
  const time = document.getElementById('slot-time').value;
  
  if(!masterId||!date||!time){
    tg.showAlert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!");
    return;
  }
  
  await fetch('/api/add_slot', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({master_id:masterId,date,time})
  });
  tg.showAlert("‚úÖ –°–ª–æ—Ç –¥–æ–±–∞–≤–ª–µ–Ω!");
  location.reload();
}

async function addMaster(){
  const name = document.getElementById('master-name').value;
  const tgId = document.getElementById('master-tg').value;
  
  if(!name||!tgId){
    tg.showAlert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!");
    return;
  }
  
  await fetch('/api/add_master', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({name,telegram_id:tgId})
  });
  tg.showAlert("‚úÖ –ú–∞—Å—Ç–µ—Ä –¥–æ–±–∞–≤–ª–µ–Ω!");
  location.reload();
}
</script>
</body></html>
