<!DOCTYPE html>
<html><head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width">
<title>üé® CRM –¢–∞—Ç—É</title>
<style>
body{font-family:system-ui;background:var(--tg-theme-bg-color);color:var(--tg-theme-text-color);padding:16px}
h1,h2{font-size:20px;margin:16px 0 8px}
input,select{width:100%;padding:12px;margin:4px 0;border-radius:8px;border:1px solid var(--tg-theme-hint-color);background:var(--tg-theme-secondary-bg-color)}
button{width:100%;padding:12px;background:var(--tg-theme-button-color);color:var(--tg-theme-button-text-color);border:none;border-radius:8px;font-weight:600;margin:8px 0}
.booking{background:var(--tg-theme-secondary-bg-color);padding:12px;border-radius:8px;margin:8px 0}
.hidden{display:none}
#slots-list{max-height:200px;overflow:auto}
</style>
</head>
<body>
<h1>üé® CRM –¢–∞—Ç—É –°–∞–ª–æ–Ω</h1>

<!-- –ö–ª–∏–µ–Ω—Ç—Å–∫–∞—è —Ñ–æ—Ä–º–∞ –∑–∞–ø–∏—Å–∏ -->
<div>
<h2>üìÖ –ó–∞–ø–∏—Å–∞—Ç—å—Å—è</h2>
<select id="slot" style="font-size:16px">
  <option>–í—ã–±–µ—Ä–∏—Ç–µ —Å–≤–æ–±–æ–¥–Ω—ã–π —Å–ª–æ—Ç</option>
  {% for slot in slots %}
  <option value="{{ slot.id }}" data-master="{{ slot.master }}" data-date="{{ slot.date }}" data-time="{{ slot.time }}">
    {{ slot.master }}: {{ slot.date }} {{ slot.time }}
  </option>
  {% endfor %}
</select>
<input id="name" placeholder="–ò–º—è –∫–ª–∏–µ–Ω—Ç–∞">
<input id="phone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω">
<input id="place" placeholder="–ú–µ—Å—Ç–æ —Ç–∞—Ç—É (—Ä—É–∫–∞, –Ω–æ–≥–∞, —Å–ø–∏–Ω–∞...)">
<button onclick="book()">–ó–∞–ø–∏—Å–∞—Ç—å—Å—è</button>
</div>

{% if is_admin %}
<!-- –ê–¥–º–∏–Ω–∫–∞ -->
<div class="admin-section">
<h2>‚öôÔ∏è –ê–¥–º–∏–Ω–∫–∞ (–º–∞—Å—Ç–µ—Ä)</h2>

<h3>–î–æ–±–∞–≤–∏—Ç—å –º–∞—Å—Ç–µ—Ä–∞</h3>
<input id="master_name" placeholder="–ò–º—è –º–∞—Å—Ç–µ—Ä–∞">
<input id="master_tg" placeholder="Telegram ID" type="number">
<button onclick="addMaster()">–î–æ–±–∞–≤–∏—Ç—å</button>

<h3>–î–æ–±–∞–≤–∏—Ç—å —Å–ª–æ—Ç</h3>
<select id="master_select">
  {% for m in masters %}
  <option value="{{ m.id }}">{{ m.name }}</option>
  {% endfor %}
</select>
<input id="slot_date" type="date">
<input id="slot_time" type="time">
<button onclick="addSlot()">–°–æ–∑–¥–∞—Ç—å —Å–ª–æ—Ç</button>
</div>
{% endif %}

<!-- –í—Å–µ –∑–∞–ø–∏—Å–∏ -->
<h2>üìã –ó–∞–ø–∏—Å–∏</h2>
<div id="bookings-list">
  {% for b in bookings %}
  <div class="booking">
    {{ b.name }} | {{ b.phone }} | {{ b.place }}<br>
    <small>{{ b.master }} {{ b.date }} {{ b.time }}</small>
  </div>
  {% endfor %}
</div>

<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script>
const tg = window.Telegram.WebApp;
tg.expand();
tg.MainButton.setText("–û–±–Ω–æ–≤–∏—Ç—å").show().onClick(()=>location.reload());

async function book() {
  const slotId = document.getElementById('slot').value;
  const name = document.getElementById('name').value;
  const phone = document.getElementById('phone').value;
  const place = document.getElementById('place').value;
  
  if(!slotId || !name || !phone || !place) {
    tg.showAlert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!");
    return;
  }
  
  const res = await fetch('/api/book', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({slot_id: slotId, name, phone, place})
  });
  const data = await res.json();
  
  tg.showAlert(data.ok ? data.message : data.error);
  if(data.ok) location.reload();
}

async function addSlot() {
  const masterId = document.getElementById('master_select').value;
  const date = document.getElementById('slot_date').value;
  const time = document.getElementById('slot_time').value;
  
  await fetch('/api/add_slot', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({master_id: masterId, date, time})
  });
  tg.showAlert("‚úÖ –°–ª–æ—Ç —Å–æ–∑–¥–∞–Ω!");
  location.reload();
}

async function addMaster() {
  const name = document.getElementById('master_name').value;
  const tgId = document.getElementById('master_tg').value;
  
  await fetch('/api/add_master', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({name, telegram_id: tgId})
  });
  tg.showAlert("‚úÖ –ú–∞—Å—Ç–µ—Ä –¥–æ–±–∞–≤–ª–µ–Ω!");
  location.reload();
}
</script>
</body></html>
